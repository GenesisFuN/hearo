# Authentication Token Fix

## Problem

API routes require authentication (`Authorization: Bearer <token>`) but the frontend components weren't sending the token.

**Error:** `401 - Authentication required - please sign in`

## Root Cause

The upload and fetch requests were missing the `Authorization` header:

```typescript
// WRONG - No auth header
fetch("/api/upload/text", {
  method: "POST",
  body: formData,
});
```

## Solution

Get the session token from Supabase and include it in all API requests:

```typescript
// CORRECT - With auth header
const {
  data: { session },
} = await supabase.auth.getSession();

fetch("/api/upload/text", {
  method: "POST",
  headers: {
    Authorization: `Bearer ${session.access_token}`,
  },
  body: formData,
});
```

## Files Updated

### 1. `src/components/UploadManager.tsx`

- ✅ Added `useAuth` import
- ✅ Added `supabase` import
- ✅ Gets session token before upload
- ✅ Includes `Authorization` header in fetch request
- ✅ Shows error if not authenticated

### 2. `src/components/BookLibrary.tsx`

- ✅ Gets session token before fetching books
- ✅ Includes `Authorization` header in fetch request
- ✅ Returns early if not authenticated

## How It Works Now

**Upload Flow:**

```
User clicks upload
    ↓
Get session token from Supabase
    ↓
Check if user is authenticated
    ↓
Send request with Authorization header
    ↓
API verifies token and gets user ID
    ↓
Save file with correct creator_id
```

**Fetch Books Flow:**

```
User opens "My Books"
    ↓
Get session token from Supabase
    ↓
Send request with Authorization header
    ↓
API verifies token and filters by user ID
    ↓
Return only user's books
```

## Testing

1. ✅ Make sure you're signed in
2. ✅ Try uploading a text file
3. ✅ Should work now (no 401 error)
4. ✅ Check "My Books" - should see your uploaded books

## Session Token Details

The token comes from Supabase Auth:

```typescript
const {
  data: { session },
} = await supabase.auth.getSession();
// session.access_token = JWT containing user info
```

The API routes decode this token to:

- Verify the user is authenticated
- Get the user's ID
- Filter data by user

## Security

✅ **Tokens are secure:**

- Generated by Supabase Auth
- JWT (JSON Web Token) format
- Expires after a set time
- Auto-refreshed by Supabase client

✅ **RLS policies enforce isolation:**

- Even if token is compromised, RLS prevents access to other users' data
- Database-level security (not just API-level)

## Error Handling

If not authenticated:

```typescript
if (!session) {
  throw new Error("Not authenticated - please sign in again");
}
```

User sees: "Not authenticated - please sign in again"
Action: Redirect to `/login`

---

**Status:** ✅ **FIXED!** All API routes now receive proper authentication tokens.
